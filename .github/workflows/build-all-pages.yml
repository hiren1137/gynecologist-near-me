name: Build All Pages (7800 Doctors)

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      runner_size:
        description: 'Runner size (larger = faster but more expensive)'
        required: true
        default: 'ubuntu-latest-8-cores'
        type: choice
        options:
          - ubuntu-latest-4-cores
          - ubuntu-latest-8-cores
          - ubuntu-latest-16-cores

jobs:
  build-all-pages:
    runs-on: ${{ github.event.inputs.runner_size }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ”§ Install dependencies
        run: npm ci
        
      - name: ğŸŒ Setup environment variables
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV
          
      - name: ğŸ“ Update build configuration for ALL pages
        run: |
          # Backup current doctor page
          cp src/pages/city/[city]/[doctor].astro src/pages/city/[city]/[doctor].astro.backup
          
          # Update to build ALL doctors (remove limit)
          sed -i.bak 's/getDoctorsWithLimit(500)/getDoctorsWithLimit(7800)/g' src/pages/city/[city]/[doctor].astro
          
          echo "âœ… Updated to build ALL 7,800 doctor pages"
          
      - name: ğŸ—ï¸ Build all pages
        run: |
          echo "ğŸš€ Starting build of ALL pages..."
          echo "ğŸ“Š Expected: ~7,800 doctor pages + 312 city pages + 31 state pages"
          echo "â±ï¸ Estimated time: 20-40 minutes"
          
          # Build with verbose output
          npm run build -- --verbose
          
      - name: ğŸ“Š Build summary
        run: |
          echo "ğŸ“ˆ Build completed!"
          echo "ğŸ“ Total files in dist/:"
          find dist -type f -name "*.html" | wc -l
          echo "ğŸ“¦ Total build size:"
          du -sh dist/
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: complete-static-site-${{ github.run_number }}
          path: dist/
          retention-days: 30
          compression-level: 6
          
      - name: ğŸ”„ Restore original configuration
        if: always()
        run: |
          # Restore original doctor page configuration
          if [ -f "src/pages/city/[city]/[doctor].astro.backup" ]; then
            mv src/pages/city/[city]/[doctor].astro.backup src/pages/city/[city]/[doctor].astro
            echo "âœ… Restored original configuration"
          fi
          
      - name: ğŸ“‹ Build report
        if: always()
        run: |
          echo "ğŸ¯ Build Report:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Runner: ${{ github.event.inputs.runner_size }}"
          echo "â±ï¸ Build time: ${{ steps.build.outputs.build-time }}"
          echo "ğŸ“ Total pages: $(find dist -name "*.html" 2>/dev/null | wc -l || echo 'Build failed')"
          echo "ğŸ’¾ Build size: $(du -sh dist/ 2>/dev/null | cut -f1 || echo 'N/A')"
          echo "ğŸ”— Download artifacts from: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" 