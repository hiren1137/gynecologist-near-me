---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { dbHelpers } from '../lib/supabase.js';

// This page will be pre-generated (static) at build time
export const prerender = true;

export async function getStaticPaths() {
  const states = await dbHelpers.getStates();
  
  if (!states || states.length === 0) {
    console.error('No states data found from Supabase');
    throw new Error('Failed to fetch states data from Supabase');
  }
  
  return states.map((state) => ({
    params: { state: state.name.toLowerCase().replace(/\s+/g, '-') },
    props: { state }
  }));
}

const { state } = Astro.props;

// Fetch real doctors data from Supabase
const rawGynecologists = await dbHelpers.getGynecologistsByState(state.name);

// Utility function to create URL-friendly slugs (same as data.ts)
function createSlug(text) {
  return text
    .toLowerCase()
    .replace(/dr\.?\s*/gi, 'dr-') // Handle "Dr." prefix
    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters except hyphens
    .replace(/\s+/g, '-') // Replace spaces with hyphens
    .replace(/-+/g, '-') // Replace multiple hyphens with single
    .replace(/^-|-$/g, '') // Remove leading/trailing hyphens
    .trim();
}

// Extract qualification from name
function extractQualification(name) {
  const match = name.match(/ - (.+)$/);
  return match ? match[1] : 'MBBS, MD (Obstetrics & Gynecology)';
}

// Parse image URLs (matching city pages logic)
function parseImageUrls(imageUrls) {
  if (Array.isArray(imageUrls)) {
    return imageUrls;
  }
  if (typeof imageUrls === 'string' && imageUrls) {
    return imageUrls.split(' | ').filter(url => url.trim());
  }
  return [];
}

// Transform data to match city pages format and sort by rating (high to low)
const gynecologists = rawGynecologists
  .map((doctor) => {
    const doctorName = doctor.name?.replace(/ - .*$/, '') || 'Unknown Doctor';
    const citySlug = createSlug(doctor.city || '');
    
    const images = parseImageUrls(doctor.image_urls);
    
    return {
      ...doctor,
      name: doctorName,
      slug: createSlug(doctorName),
      qualification: extractQualification(doctor.name || ''),
      citySlug: citySlug,
      images: images,
      rating: parseFloat(doctor.rating) || 4.5,
      totalReviews: doctor.total_ratings || 0
    };
  })
  .sort((a, b) => {
    // Sort by rating first (highest to lowest), then by total reviews
    if (b.rating !== a.rating) {
      return b.rating - a.rating;
    }
    return b.totalReviews - a.totalReviews;
  });
---

<Layout 
  title={`Best Gynecologists in ${state.name} - Expert Women's Healthcare Specialists`}
  description={`Find top-rated gynecologists in ${state.name}. Expert women's healthcare specialists with verified credentials, patient reviews, and easy appointment booking.`}
  keywords={`gynecologist ${state.name}, women's health ${state.name}, obstetrics ${state.name}, pregnancy care ${state.name}`}
>
  <Header />
  
  <main>
    <!-- Breadcrumb -->
    <nav class="bg-gray-50 py-4">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center space-x-2 text-sm text-gray-600">
          <a href="/" class="hover:text-pink-600">Home</a>
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="text-pink-600 font-medium">{state.name}</span>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-pink-50 to-purple-50 py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center">
          <h1 class="text-3xl md:text-5xl font-bold text-gray-900 mb-4">
            Best Gynecologists in <span class="text-pink-600">{state.name}</span>
          </h1>
          <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
            Find expert women's healthcare specialists in {state.name}. Book appointments with top-rated gynecologists near you.
          </p>
          
          <!-- Quick Stats -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-2xl mx-auto">
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <div class="text-2xl font-bold text-pink-600">{gynecologists.length}+</div>
              <div class="text-sm text-gray-600">Expert Doctors</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <div class="text-2xl font-bold text-pink-600">{state.cities.length}</div>
              <div class="text-sm text-gray-600">Cities Covered</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <div class="text-2xl font-bold text-pink-600">4.8â˜…</div>
              <div class="text-sm text-gray-600">Average Rating</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm">
              <div class="text-2xl font-bold text-pink-600">31</div>
              <div class="text-sm text-gray-600">States Covered</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Cities in State -->
    <section class="py-12 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8 text-center">
          Popular Cities in {state.name}
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
          {state.cities.map((city) => (
            <a 
              href={`/city/${city.toLowerCase().replace(/\s+/g, '-')}`}
              class="bg-gray-50 hover:bg-pink-50 border border-gray-200 hover:border-pink-300 rounded-lg p-4 text-center transition-all duration-200 group active:scale-95 touch-manipulation"
            >
              <div class="font-medium text-gray-900 group-hover:text-pink-600">
                {city}
              </div>
              <div class="text-sm text-gray-500 mt-1">
                Find Doctors
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>

    <!-- Gynecologists List -->
    {gynecologists.length > 0 && (
      <section class="py-12 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-8 text-center">
            Top Gynecologists in {state.name}
          </h2>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {gynecologists.map((doctor) => (
              <div class="bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 border border-gray-200 overflow-hidden">
                <div class="p-6">
                  <div class="flex items-start space-x-4">
                    <!-- Doctor Image -->
                    <div class="flex-shrink-0">
                      {doctor.images && doctor.images.length > 0 ? (
                        <div class="w-20 h-20 lg:w-24 lg:h-24 rounded-xl overflow-hidden shadow-md">
                          <img 
                            src={doctor.images[0]} 
                            alt={doctor.name}
                            class="w-full h-full object-cover"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                          />
                          <div class="w-full h-full bg-gradient-to-br from-pink-100 to-pink-200 rounded-xl flex items-center justify-center" style="display: none;">
                            <svg class="w-10 h-10 lg:w-12 lg:h-12 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                          </div>
                        </div>
                      ) : (
                        <div class="w-20 h-20 lg:w-24 lg:h-24 bg-gradient-to-br from-pink-100 to-pink-200 rounded-xl flex items-center justify-center shadow-md">
                          <svg class="w-10 h-10 lg:w-12 lg:h-12 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                          </svg>
                        </div>
                      )}
                    </div>
                    
                    <div class="flex-1 min-w-0">
                      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-3">
                        <div class="flex-1">
                          <h3 class="text-lg lg:text-xl font-semibold text-gray-900 mb-1 hover:text-pink-600 transition-colors">
                            <a href={`/city/${doctor.citySlug}/${doctor.slug}`}>
                              {doctor.name}
                            </a>
                          </h3>
                          <p class="text-sm text-gray-600 mb-2">{doctor.qualification}</p>
                        </div>
                        <div class="text-right mt-2 sm:mt-0">
                          <div class="flex items-center justify-end">
                            <svg class="w-4 h-4 text-yellow-400 fill-current" viewBox="0 0 20 20">
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                            <span class="text-sm font-medium text-gray-900 ml-1">{doctor.rating}</span>
                          </div>
                          <span class="text-xs text-gray-500">({doctor.totalReviews} reviews)</span>
                        </div>
                      </div>
                      
                      <div class="mb-4">
                        <div class="text-sm text-gray-500">Hospital/Clinic</div>
                        <div class="font-medium text-gray-900 truncate">{doctor.hospital || 'Private Practice'}</div>
                        <div class="text-sm text-gray-600 mt-1 line-clamp-2">{doctor.address}</div>
                      </div>
                      

                      
                      <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                        <div>
                          <div class="text-sm text-gray-500">City</div>
                          <div class="text-lg font-semibold text-pink-600">{doctor.city}</div>
                        </div>
                        <div class="flex space-x-2">
                          {doctor.phone && (
                            <a 
                              href={`tel:${doctor.phone}`}
                              class="bg-pink-600 text-white px-4 py-3 rounded-lg text-sm font-medium hover:bg-pink-700 transition-all duration-200 flex items-center active:scale-95 touch-manipulation"
                            >
                              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                              </svg>
                              Call
                            </a>
                          )}
                          <a 
                            href={`/city/${doctor.citySlug}/${doctor.slug}`}
                            class="bg-gray-100 text-gray-700 px-4 py-3 rounded-lg text-sm font-medium hover:bg-gray-200 transition-all duration-200 active:scale-95 touch-manipulation"
                          >
                            View Profile
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- SEO Content -->
    <section class="py-12 bg-white">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="prose prose-lg max-w-none">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Finding the Right Gynecologist in {state.name}
          </h2>
          <p class="text-gray-600 mb-6">
            When it comes to women's healthcare in {state.name}, choosing the right gynecologist is crucial for your health and well-being. 
            Our platform connects you with verified, experienced gynecologists across {state.name} who specialize in various aspects of women's health.
          </p>
          
          <h3 class="text-xl font-semibold text-gray-900 mb-4">
            Why Choose Our Listed Gynecologists in {state.name}?
          </h3>
          <ul class="list-disc list-inside text-gray-600 space-y-2 mb-6">
            <li>Board-certified and experienced specialists</li>
            <li>Comprehensive women's healthcare services</li>
            <li>Modern facilities and advanced treatment options</li>
            <li>Patient-centered care approach</li>
            <li>Easy appointment booking and consultation</li>
          </ul>

          <h3 class="text-xl font-semibold text-gray-900 mb-4">
            Common Services Offered by Gynecologists in {state.name}
          </h3>
          <ul class="list-disc list-inside text-gray-600 space-y-2 mb-6">
            <li>Routine gynecological examinations</li>
            <li>Pregnancy care and prenatal services</li>
            <li>Family planning and contraceptive counseling</li>
            <li>Menstrual disorder treatment</li>
            <li>Menopause management</li>
            <li>Fertility treatments and reproductive health</li>
            <li>Gynecological surgery and procedures</li>
          </ul>

          <p class="text-gray-600">
            Book your appointment today with a trusted gynecologist in {state.name} and take the first step towards better women's healthcare.
          </p>
        </div>
      </div>
    </section>
  </main>

  <Footer />
</Layout> 