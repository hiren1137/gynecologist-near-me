---
import Layout from '../layouts/Layout.astro';
import { dbHelpers } from '../lib/supabase.js';

// Test database connection and filters
let testResults = {
  connectionTest: false,
  statesCount: 0,
  citiesCount: 0,
  doctorsCount: 0,
  sampleCities: [],
  sampleStates: [],
  mumbaiTest: 0,
  maharashtraTest: 0
};

try {
  // Test basic connection
  console.log('üîå Testing database connection...');
  
  // Test states
  const states = await dbHelpers.getStates();
  testResults.statesCount = states.length;
  testResults.sampleStates = states.slice(0, 5).map(s => s.name);
  
  // Test cities
  const cities = await dbHelpers.getTopCities();
  testResults.citiesCount = cities.length;
  testResults.sampleCities = cities.slice(0, 10);
  
  // Test general search
  const allDoctors = await dbHelpers.searchGynecologists({});
  testResults.doctorsCount = allDoctors.length;
  
  // Test specific city filter - Mumbai
  const mumbaiDoctors = await dbHelpers.getGynecologistsByCity('Mumbai');
  testResults.mumbaiTest = mumbaiDoctors.length;
  
  // Test specific state filter - Maharashtra  
  const maharashtraDoctors = await dbHelpers.getGynecologistsByState('Maharashtra');
  testResults.maharashtraTest = maharashtraDoctors.length;
  
  // Show sample doctor data from general search
  if (allDoctors.length > 0) {
    const sampleDoctor = allDoctors[0];
    testResults.sampleDoctor = {
      name: sampleDoctor.name,
      city: sampleDoctor.city,
      state: sampleDoctor.state,
      rating: sampleDoctor.rating
    };
    
    // Get unique cities and states from actual data
    const uniqueCities = [...new Set(allDoctors.slice(0, 100).map(d => d.city))].filter(Boolean);
    const uniqueStates = [...new Set(allDoctors.slice(0, 100).map(d => d.state))].filter(Boolean);
    
    testResults.actualCities = uniqueCities.slice(0, 20);
    testResults.actualStates = uniqueStates.slice(0, 15);
  }
  
  testResults.connectionTest = true;
  
  console.log('‚úÖ Test Results:', testResults);
  
} catch (error) {
  console.error('‚ùå Database test failed:', error);
  testResults.error = error.message;
}
---

<Layout title="Database Test Results">
  <div class="max-w-4xl mx-auto p-8">
    <h1 class="text-3xl font-bold mb-6">Database Test Results</h1>
    
    <div class="space-y-6">
      <!-- Connection Test -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Connection Test</h2>
        <div class={`p-4 rounded ${testResults.connectionTest ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
          {testResults.connectionTest ? '‚úÖ Connected' : '‚ùå Failed'}
          {testResults.error && <div class="mt-2">Error: {testResults.error}</div>}
        </div>
      </div>

      <!-- Basic Stats -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Basic Stats</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="text-center">
            <div class="text-2xl font-bold text-blue-600">{testResults.statesCount}</div>
            <div class="text-sm text-gray-600">States</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-green-600">{testResults.citiesCount}</div>
            <div class="text-sm text-gray-600">Top Cities</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-purple-600">{testResults.doctorsCount}</div>
            <div class="text-sm text-gray-600">Total Doctors</div>
          </div>
        </div>
      </div>

      <!-- Filter Tests -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Filter Tests</h2>
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-gray-50 rounded">
            <div class="font-medium">Mumbai Filter</div>
            <div class="text-2xl font-bold text-blue-600">{testResults.mumbaiTest} doctors</div>
          </div>
          <div class="p-4 bg-gray-50 rounded">
            <div class="font-medium">Maharashtra Filter</div>
            <div class="text-2xl font-bold text-green-600">{testResults.maharashtraTest} doctors</div>
          </div>
        </div>
      </div>

      <!-- Sample Data -->
      {testResults.sampleDoctor && (
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">Sample Doctor</h2>
          <div class="bg-gray-50 p-4 rounded">
            <div><strong>Name:</strong> {testResults.sampleDoctor.name}</div>
            <div><strong>City:</strong> {testResults.sampleDoctor.city}</div>
            <div><strong>State:</strong> {testResults.sampleDoctor.state}</div>
            <div><strong>Rating:</strong> {testResults.sampleDoctor.rating}</div>
          </div>
        </div>
      )}

      <!-- Actual Cities in Database -->
      {testResults.actualCities && (
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">Actual Cities in Database (First 20)</h2>
          <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-sm">
            {testResults.actualCities.map(city => (
              <div class="bg-blue-50 p-2 rounded text-center">{city}</div>
            ))}
          </div>
        </div>
      )}

      <!-- Actual States in Database -->
      {testResults.actualStates && (
        <div class="bg-white p-6 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-4">Actual States in Database (First 15)</h2>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
            {testResults.actualStates.map(state => (
              <div class="bg-green-50 p-2 rounded text-center">{state}</div>
            ))}
          </div>
        </div>
      )}

      <!-- Sample Cities from Config -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Sample Cities from Config</h2>
        <div class="grid grid-cols-3 md:grid-cols-5 gap-2 text-sm">
          {testResults.sampleCities.map(city => (
            <div class="bg-gray-50 p-2 rounded text-center">{city}</div>
          ))}
        </div>
      </div>

      <!-- Test URLs -->
      <div class="bg-white p-6 rounded-lg shadow">
        <h2 class="text-xl font-semibold mb-4">Test Filter URLs</h2>
        <div class="space-y-2">
          <a href="/find-doctor?city=Mumbai" class="block bg-blue-50 p-3 rounded hover:bg-blue-100">
            Test Mumbai Filter: /find-doctor?city=Mumbai
          </a>
          <a href="/find-doctor?state=Maharashtra" class="block bg-green-50 p-3 rounded hover:bg-green-100">
            Test Maharashtra Filter: /find-doctor?state=Maharashtra
          </a>
          <a href="/find-doctor?search=Dr" class="block bg-purple-50 p-3 rounded hover:bg-purple-100">
            Test Search Filter: /find-doctor?search=Dr
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout> 